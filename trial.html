<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India Air Quality & Allergen Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4184P5L1WJ5p5lC5Z2+D6S5W6C5Z2+D6S5W6C5Z2+D6S5W6C5Z2+D6S5W6"
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-2sO+N8z2eNf9d0+3V8y6C5d8u3C9J3S3J2D6S5W6C5d8u3C9J3S3J2D6S5W6C5d8u3C9J3S3J2D6S5W6C5d8u3C9J3S3J2D6S5W6"
        crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        #map {
            height: 90vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Hyperlocal India Air Quality Map (MVP)</h1>
    <div id="map"></div>

    <script>
        const API_URL = "http://localhost:8000";

        // Initialize the map centered on India
        const map = L.map('map').setView([20.5937, 78.9629], 5);

        // Add a base map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fetch and display sensor data
        async function fetchSensorData() {
            try {
                // For MVP, we'll use a hardcoded list of major Indian cities as a proxy
                const cities = ['Delhi', 'Mumbai', 'Kolkata', 'Chennai', 'Bengaluru', 'Pune'];
                let allSensors = [];

                for (const city of cities) {
                    const response = await fetch(`${API_URL}/sensors?city=${city}`);
                    const data = await response.json();
                    allSensors = allSensors.concat(data);
                }
                
                // Plot sensor markers
                const sensorGroup = L.layerGroup().addTo(map);
                allSensors.forEach(sensor => {
                    const marker = L.circleMarker([sensor.lat, sensor.lon], {
                        color: 'blue',
                        fillColor: '#30f',
                        fillOpacity: 0.5,
                        radius: 5
                    }).addTo(sensorGroup);
                    marker.bindPopup(`<b>${sensor.source}</b><br>PM2.5: ${sensor.pm25.toFixed(2)} µg/m³`);
                });
            } catch (error) {
                console.error("Error fetching sensor data:", error);
            }
        }
        
        // Fetch and display a predicted heatmap
        async function fetchAndRenderHeatmap() {
            try {
                // Use a sample bounding box for Delhi for the MVP
                const bbox = "76.84,28.35,77.4,28.89";
                const response = await fetch(`${API_URL}/grid?bbox=${bbox}`);
                const grid_data = await response.json();

                // Convert data to Leaflet-Heat format: [[lat, lon, intensity], ...]
                const heatData = grid_data.map(p => [p.lat, p.lon, p.value]);
                
                L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    max: 500, // Max value for color scaling
                    gradient: {
                        0.0: 'green',
                        0.25: 'yellow',
                        0.5: 'orange',
                        0.75: 'red',
                        1.0: 'darkred'
                    }
                }).addTo(map);

            } catch (error) {
                console.error("Error fetching heatmap data:", error);
            }
        }

        // Call functions to populate the map
        fetchSensorData();
        fetchAndRenderHeatmap();
    </script>
</body>
</html>